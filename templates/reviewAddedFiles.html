<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artwork Admin Review</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}">
</head>
<body class="admin-page">
    <header class="admin-header">
        <div class="admin-header__intro">
            <h1>Artwork Administration</h1>
            <p class="admin-subheading">Upload, curate, and describe every image that appears in your public gallery.</p>
        </div>
        <nav class="admin-nav">
            <a href="/" class="button secondary">View Public Gallery</a>
            <button type="button" id="refresh-pending" class="button secondary">Refresh Library</button>
            <button type="button" id="theme-toggle" class="button secondary" title="Toggle light/dark">ðŸŒ™ Dark</button>
        </nav>
    </header>

    <main class="admin-layout">
        <section class="admin-panel admin-panel--settings">
            <h2>
                AI Metadata Settings
                <span class="info-tip" aria-label="Controls for OpenAI-powered metadata generation and when it runs." title="Controls for OpenAI-powered metadata generation and when it runs."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
            </h2>
            <p class="panel-description">Control automatic title, description, and caption generation for new or unreviewed images.</p>
            <ul class="legend-list" aria-label="AI settings quick guide">
                <li><strong>Enable AI</strong>: Master switch to allow AI to fill missing fields.</li>
                <li><strong>Startup enrichment</strong>: Runs once at boot for items missing metadata.</li>
                <li><strong>Startup sidecars</strong>: Creates JSON sidecars if missing during initial scan.</li>
            </ul>
            <form id="ai-config-form" class="ai-config-form">
                <div class="form-row">
                    <label class="checkbox" title="Master switch for automatic metadata generation using OpenAI.">
                        <input type="checkbox" id="ai-enabled">
                        <span>Enable AI metadata generation</span>
                        <span class="info-tip" aria-label="Master switch for automatic metadata generation using OpenAI." title="Master switch for automatic metadata generation using OpenAI."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                </div>
                <div class="form-row">
                    <label class="checkbox" title="On server startup, analyze images needing metadata and request AI to fill missing fields.">
                        <input type="checkbox" id="ai-startup-enabled">
                        <span>Run AI enrichment during startup scan</span>
                        <span class="info-tip" aria-label="On server startup, analyze images needing metadata and request AI to fill missing fields." title="On server startup, analyze images needing metadata and request AI to fill missing fields."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                </div>
                <div class="form-row">
                    <label class="checkbox" title="On server startup, create missing JSON sidecar files for images discovered in the library.">
                        <input type="checkbox" id="sidecar-startup-enabled">
                        <span>Create JSON sidecars during startup scan</span>
                        <span class="info-tip" aria-label="On server startup, create missing JSON sidecar files for images discovered in the library." title="On server startup, create missing JSON sidecar files for images discovered in the library."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                </div>
                <div class="form-row">
                    <label for="sidecar-max-workers" title="Upper limit of worker processes allowed to create sidecars during startup scans.">
                        Max workers creating sidecars
                        <span class="info-tip" aria-label="Upper limit of worker processes allowed to create sidecars during startup scans." title="Upper limit of worker processes allowed to create sidecars during startup scans."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                    <input type="number" id="sidecar-max-workers" min="1" max="64" step="1" value="2">
                </div>
                <div class="form-row">
                    <label for="ai-model" title="Preferred model for AI metadata generation. Choose 'auto' to let the server decide.">
                        Model
                        <span class="info-tip" aria-label="Preferred model for AI metadata generation. Choose 'auto' to let the server decide." title="Preferred model for AI metadata generation. Choose 'auto' to let the server decide."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                    <select id="ai-model">
                        {% for option in model_options %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <label for="ai-temp" title="Higher values are more creative; lower values are more consistent.">
                        Temperature
                        <span class="info-tip" aria-label="Higher values are more creative; lower values are more consistent." title="Higher values are more creative; lower values are more consistent."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                    <input type="number" id="ai-temp" min="0" max="2" step="0.1" value="0.6">
                </div>
                <div class="form-row">
                    <label for="ai-tokens" title="Upper bound on response length. Keep modest for concise gallery text.">
                        Max output tokens
                        <span class="info-tip" aria-label="Upper bound on response length. Keep modest for concise gallery text." title="Upper bound on response length. Keep modest for concise gallery text."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    </label>
                    <input type="number" id="ai-tokens" min="16" max="4000" step="1" value="600">
                </div>
                <div class="form-actions">
                    <button type="submit" class="button">Save settings</button>
                    <button type="button" id="reset-ai-config" class="button tertiary">Reset to defaults</button>
                </div>
            </form>
        </section>

        <section class="admin-panel admin-panel--upload">
            <h2>
                Upload new artwork
                <span class="info-tip" aria-label="Drop images or JSON sidecars. Images are stored under Static/images." title="Drop images or JSON sidecars. Images are stored under Static/images."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
            </h2>
            <p class="panel-description">Drag and drop images or click below to upload. JSON sidecars are supported for bulk imports.</p>
            <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Drop images here or press enter to choose files">
                <svg aria-hidden="true" focusable="false" class="dropzone-icon" viewBox="0 0 24 24">
                    <path d="M12 2a5 5 0 0 1 5 5h3a1 1 0 1 1 0 2h-3v2h1a4 4 0 1 1 0 8H7a5 5 0 0 1-1-9.9V9H3a1 1 0 1 1 0-2h3a5 5 0 0 1 6-5Zm0 2a3 3 0 0 0-3 3v2a1 1 0 0 1-1 1H7a3 3 0 1 0 0 6h11a2 2 0 1 0 0-4h-2a1 1 0 0 1-1-1V7a3 3 0 0 0-3-3Zm0 4a1 1 0 0 1 1 1v2.585l1.293-1.293a1 1 0 1 1 1.414 1.414l-3.004 3.003a1 1 0 0 1-1.414 0l-3.004-3.003a1 1 0 0 1 1.414-1.414L11 11.585V9a1 1 0 0 1 1-1Z" fill="currentColor"/>
                </svg>
                <p><strong>Drop files here</strong> or use the button below.</p>
                <button type="button" id="select-files" class="button">Choose files</button>
                <input type="file" id="file-input" name="files" accept="image/*,.json" multiple hidden>
                <p class="supported-formats">Supported formats: {{ allowed_extensions | join(', ') }} and JSON sidecars.</p>
            </div>

            <form id="path-form" class="path-form">
                <h3>
                    Import from server path
                    <span class="info-tip" aria-label="Copies files from a local server path into Static/images." title="Copies files from a local server path into Static/images."><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                </h3>
                <p class="panel-description">Paste an absolute file or directory path accessible to the server. Images are copied into <code>Static/images</code>.</p>
                <label for="path-input" class="sr-only">Absolute path on the server</label>
                <div class="path-input-row">
                    <input type="text" id="path-input" name="path" placeholder="/home/user/photos" required>
                    <button type="submit" class="button">Import</button>
                </div>
            </form>
        </section>

        <section class="admin-panel admin-panel--pending">
            <div class="panel-header">
                <div>
                    <h2>Needs review <span id="pending-count" class="badge">{{ pending_images | length }}</span></h2>
                    <p class="panel-description">Review each image to confirm or edit the metadata before it appears publicly.</p>
                </div>
                <div class="panel-actions">
                    <label for="pending-sort" class="sr-only">Sort pending</label>
                    <select id="pending-sort" title="Sort pending images by date or title">
                        <option value="detected_at:desc">Newest first</option>
                        <option value="detected_at:asc">Oldest first</option>
                        <option value="title:asc">Title Aâ€“Z</option>
                        <option value="title:desc">Title Zâ€“A</option>
                        <option value="name:asc">Filename Aâ€“Z</option>
                        <option value="name:desc">Filename Zâ€“A</option>
                    </select>
                    <span class="info-tip" aria-label="Sort pending images by date or title" title="Sort pending images by date or title"><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    <label class="checkbox" title="Overwrite existing fields when regenerating">
                        <input type="checkbox" id="force-overwrite">
                        <span>Force overwrite</span>
                        <span class="info-tip" aria-label="Overwrite existing fields when regenerating AI metadata." title="Overwrite existing fields when regenerating AI metadata.">i</span>
                    </label>
                    <button type="button" id="select-all" class="button secondary">Select all</button>
                    <button type="button" id="regen-selected" class="button">Re-run AI</button>
                </div>
            </div>
            <div id="pending-list" class="media-grid">
                {% if pending_images %}
                    {% for item in pending_images %}
                        <article class="image-card image-card--pending" data-image-name="{{ item.name }}">
                            <div class="image-card__select">
                                <input type="checkbox" class="item-select" aria-label="Select {{ item.name }}">
                            </div>
                            <div class="image-card__preview">
                                <a href="{{ url_for('preview_image_metadata', image_name=item.name) }}" title="Open details">
                                    <img src="{{ item.url }}" alt="Preview of {{ item.title or item.name }}" loading="lazy">
                                </a>
                            </div>
                            <div class="image-card__meta">
                                <div class="image-card__header">
                                    <h3>{{ item.title or item.name }}</h3>
                                    {% if item.ai_generated %}
                                        <span class="badge">AI generated</span>
                                    {% else %}
                                        <span class="badge secondary">Needs text</span>
                                    {% endif %}
                                </div>
                                <p class="filename">{{ item.name }}</p>
                                {% if item.caption %}
                                    <p class="caption">{{ item.caption }}</p>
                                {% endif %}
                                {% if item.description %}
                                    <p class="description">{{ item.description }}</p>
                                {% else %}
                                    <p class="description empty">No description detected yet.</p>
                                {% endif %}
                                <ul class="tag-list">
                                    {% for tag in item.tags %}
                                        <li>{{ tag }}</li>
                                    {% endfor %}
                                </ul>
                                <div class="image-card__footer">
                                    {% if item.ai_details and (item.ai_details.created or item.ai_details.attempted_at) %}
                                        <span class="timestamp" data-ts="{{ item.ai_details.created or item.ai_details.attempted_at }}"></span>
                                    {% endif %}
                                    <a class="button tertiary" href="{{ url_for('preview_image_metadata', image_name=item.name) }}">Review details</a>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                {% else %}
                    <p class="empty-state">No new files waiting for review. Upload artwork to begin curating descriptions.</p>
                {% endif %}
            </div>
        </section>

        <section class="admin-panel admin-panel--gallery">
            <div class="panel-header">
                <div>
                    <h2>Curated gallery <span id="gallery-count" class="badge">{{ reviewed_images | length }}</span></h2>
                    <p class="panel-description">Browse, sort, or update the artwork that is already visible to visitors.</p>
                </div>
                <div class="panel-actions">
                    <label for="gallery-sort" class="sr-only">Sort gallery</label>
                    <select id="gallery-sort" title="Sort curated artwork by date, title, or author">
                        <option value="detected_at:desc">Newest first</option>
                        <option value="detected_at:asc">Oldest first</option>
                        <option value="title:asc">Title Aâ€“Z</option>
                        <option value="title:desc">Title Zâ€“A</option>
                        <option value="author:asc">Author Aâ€“Z</option>
                        <option value="author:desc">Author Zâ€“A</option>
                    </select>
                    <span class="info-tip" aria-label="Sort curated artwork by date, title, or author" title="Sort curated artwork by date, title, or author"><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                    <label for="gallery-filter" class="sr-only">Filter gallery</label>
                    <input type="search" id="gallery-filter" placeholder="Filter by title, author, or tag" autocomplete="off" title="Type to filter the curated gallery by title, author, or tag">
                    <span class="info-tip" aria-label="Type to filter the curated gallery by title, author, or tag" title="Type to filter the curated gallery by title, author, or tag"><svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 4a1.25 1.25 0 1 1 0 2.5A1.25 1.25 0 0 1 12 6Zm2 11h-4a1 1 0 1 1 0-2h1v-3h-1a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 1 1 0 2Z"/></svg></span>
                </div>
            </div>
            <div id="reviewed-list" class="media-grid">
                {% if reviewed_images %}
                    {% for item in reviewed_images %}
                        <article class="image-card image-card--reviewed" data-image-name="{{ item.name }}">
                            <div class="image-card__preview">
                                <a href="{{ url_for('preview_image_metadata', image_name=item.name) }}" title="Open details">
                                    <img src="{{ item.url }}" alt="{{ item.title }}" loading="lazy">
                                </a>
                            </div>
                            <div class="image-card__meta">
                                <div class="image-card__header">
                                    <h3>{{ item.title }}</h3>
                                </div>
                                {% if item.caption %}
                                    <p class="caption">{{ item.caption }}</p>
                                {% endif %}
                                {% if item.author %}
                                    <p class="author">By {{ item.author }}</p>
                                {% endif %}
                                {% if item.description %}
                                    <p class="description">{{ item.description }}</p>
                                {% endif %}
                                <ul class="tag-list">
                                    {% for tag in item.tags %}
                                        <li>{{ tag }}</li>
                                    {% endfor %}
                                </ul>
                                <div class="image-card__footer">
                                    <span class="filename">{{ item.name }}</span>
                                    <div class="image-card__actions">
                                        <a class="button tertiary" href="{{ url_for('preview_image_metadata', image_name=item.name) }}">Edit</a>
                                        <button type="button" class="button secondary" data-action="regen-single">Regenerate</button>
                                        <button type="button" class="button danger" data-action="delete-image">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                {% else %}
                    <p class="empty-state">No curated artwork yet. Approve images to populate the public gallery.</p>
                {% endif %}
            </div>
        </section>
    </main>

    <section id="feedback" class="feedback" role="status" aria-live="polite" hidden></section>

    <footer>
        <p>Artwork Gallery Administration</p>
    </footer>

    <script id="admin-state" type="application/json">{{ admin_data | tojson }}</script>
    <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const selectFilesButton = document.getElementById('select-files');
    const feedback = document.getElementById('feedback');
    const pendingList = document.getElementById('pending-list');
    const pendingCount = document.getElementById('pending-count');
    const galleryList = document.getElementById('reviewed-list');
    const galleryCount = document.getElementById('gallery-count');
    const refreshButton = document.getElementById('refresh-pending');
    const pathForm = document.getElementById('path-form');
    const aiForm = document.getElementById('ai-config-form');
    const aiEnabled = document.getElementById('ai-enabled');
    const aiStartupEnabled = document.getElementById('ai-startup-enabled');
    const sidecarStartupEnabled = document.getElementById('sidecar-startup-enabled');
    const aiModel = document.getElementById('ai-model');
    const aiTemp = document.getElementById('ai-temp');
    const aiTokens = document.getElementById('ai-tokens');
    const sidecarMaxWorkers = document.getElementById('sidecar-max-workers');
    const resetAiButton = document.getElementById('reset-ai-config');
    const selectAllBtn = document.getElementById('select-all');
    const regenBtn = document.getElementById('regen-selected');
    const forceOverwrite = document.getElementById('force-overwrite');
    const gallerySort = document.getElementById('gallery-sort');
    const pendingSort = document.getElementById('pending-sort');
    const galleryFilter = document.getElementById('gallery-filter');
    const adminState = document.getElementById('admin-state');
    const themeToggle = document.getElementById('theme-toggle');
    const reviewUrlTemplate = "{{ url_for('preview_image_metadata', image_name='__IMAGE__') }}";

    let dashboardData = { pending: [], reviewed: [], all: [] };
    if (adminState) {
        try {
            dashboardData = JSON.parse(adminState.textContent) || dashboardData;
        } catch (err) {
            console.error('Failed to parse initial admin state', err);
        }
    }

    let pendingData = dashboardData.pending || [];
    let reviewedData = dashboardData.reviewed || [];

    // Theme: init from storage or system preference
    (function initTheme() {
        try {
            const saved = localStorage.getItem('adminTheme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = (saved === 'light' || saved === 'dark') ? saved : (prefersDark ? 'dark' : 'light');
            applyTheme(theme);
        } catch (_) {}
    })();

    function applyTheme(theme) {
        const body = document.body;
        body.classList.remove('theme-light', 'theme-dark');
        body.classList.add(theme === 'dark' ? 'theme-dark' : 'theme-light');
        if (themeToggle) {
            themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
            themeToggle.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
        }
        try { localStorage.setItem('adminTheme', theme); } catch (_) {}
    }

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.contains('theme-dark');
            applyTheme(isDark ? 'light' : 'dark');
        });
    }

    function showFeedback(message, type = 'info') {
        feedback.textContent = message;
        feedback.classList.remove('error', 'success');
        feedback.classList.add(type === 'error' ? 'error' : 'success');
        feedback.hidden = false;
        window.setTimeout(() => {
            feedback.hidden = true;
        }, 8000);
    }

    function formatTimestamp(ts) {
        if (!ts) return '';
        return new Date(ts * 1000).toLocaleString();
    }

    function buildTagList(tags) {
        const list = document.createElement('ul');
        list.className = 'tag-list';
        (tags || []).forEach((tag) => {
            if (!tag) return;
            const item = document.createElement('li');
            item.textContent = tag;
            list.appendChild(item);
        });
        return list;
    }

    function createCardActions(item, type) {
        const actions = document.createElement('div');
        actions.className = 'image-card__actions';
        if (type === 'reviewed') {
            const editLink = document.createElement('a');
            editLink.className = 'button tertiary';
            editLink.href = reviewUrlTemplate.replace('__IMAGE__', encodeURIComponent(item.name));
            editLink.textContent = 'Edit';
            actions.appendChild(editLink);

            const regenBtnSingle = document.createElement('button');
            regenBtnSingle.type = 'button';
            regenBtnSingle.className = 'button secondary';
            regenBtnSingle.dataset.action = 'regen-single';
            regenBtnSingle.textContent = 'Regenerate';
            actions.appendChild(regenBtnSingle);

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'button danger';
            deleteBtn.dataset.action = 'delete-image';
            deleteBtn.textContent = 'Delete';
            actions.appendChild(deleteBtn);
        } else {
            const reviewLink = document.createElement('a');
            reviewLink.className = 'button tertiary';
            reviewLink.href = reviewUrlTemplate.replace('__IMAGE__', encodeURIComponent(item.name));
            reviewLink.textContent = 'Review details';
            actions.appendChild(reviewLink);
        }
        return actions;
    }

    function renderPendingList(pending) {
        pendingData = pending || [];
        pendingList.innerHTML = '';
        pendingCount.textContent = pendingData.length;
        if (!pendingData.length) {
            const emptyMessage = document.createElement('p');
            emptyMessage.className = 'empty-state';
            emptyMessage.textContent = 'No new files waiting for review. Upload artwork to begin curating descriptions.';
            pendingList.appendChild(emptyMessage);
            return;
        }

        pendingData.forEach((item) => {
            const card = document.createElement('article');
            card.className = 'image-card image-card--pending';
            card.dataset.imageName = item.name;

            const selectCol = document.createElement('div');
            selectCol.className = 'image-card__select';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'item-select';
            checkbox.setAttribute('aria-label', `Select ${item.name}`);
            selectCol.appendChild(checkbox);
            card.appendChild(selectCol);

            const preview = document.createElement('div');
            preview.className = 'image-card__preview';
            const link = document.createElement('a');
            link.href = reviewUrlTemplate.replace('__IMAGE__', encodeURIComponent(item.name));
            link.title = 'Open details';
            const img = document.createElement('img');
            img.src = item.url;
            img.alt = `Preview of ${item.title || item.name}`;
            img.loading = 'lazy';
            link.appendChild(img);
            preview.appendChild(link);
            card.appendChild(preview);

            const meta = document.createElement('div');
            meta.className = 'image-card__meta';

            const header = document.createElement('div');
            header.className = 'image-card__header';
            const title = document.createElement('h3');
            title.textContent = item.title || item.name;
            header.appendChild(title);
            const badge = document.createElement('span');
            badge.className = item.ai_generated ? 'badge' : 'badge secondary';
            badge.textContent = item.ai_generated ? 'AI generated' : 'Needs text';
            header.appendChild(badge);
            meta.appendChild(header);

            const filename = document.createElement('p');
            filename.className = 'filename';
            filename.textContent = item.name;
            meta.appendChild(filename);

            if (item.caption) {
                const caption = document.createElement('p');
                caption.className = 'caption';
                caption.textContent = item.caption;
                meta.appendChild(caption);
            }

            const description = document.createElement('p');
            description.className = item.description ? 'description' : 'description empty';
            description.textContent = item.description || 'No description detected yet.';
            meta.appendChild(description);

            if (item.tags && item.tags.length) {
                meta.appendChild(buildTagList(item.tags));
            }

            const footer = document.createElement('div');
            footer.className = 'image-card__footer';
            if (item.ai_details) {
                const ts = item.ai_details.created || item.ai_details.attempted_at || item.detected_at;
                if (ts) {
                    const time = document.createElement('span');
                    time.className = 'timestamp';
                    time.textContent = formatTimestamp(ts);
                    footer.appendChild(time);
                }
            }
            footer.appendChild(createCardActions(item, 'pending'));
            meta.appendChild(footer);

            card.appendChild(meta);
            pendingList.appendChild(card);
        });
    }

    function applyGalleryView(list) {
        galleryList.innerHTML = '';
        galleryCount.textContent = list.length;
        if (!list.length) {
            const emptyMessage = document.createElement('p');
            emptyMessage.className = 'empty-state';
            emptyMessage.textContent = 'No curated artwork yet. Approve images to populate the public gallery.';
            galleryList.appendChild(emptyMessage);
            return;
        }
        list.forEach((item) => {
            const card = document.createElement('article');
            card.className = 'image-card image-card--reviewed';
            card.dataset.imageName = item.name;

            const preview = document.createElement('div');
            preview.className = 'image-card__preview';
            const img = document.createElement('img');
            img.src = item.url;
            img.alt = item.title || item.name;
            img.loading = 'lazy';
            preview.appendChild(img);
            card.appendChild(preview);

            const meta = document.createElement('div');
            meta.className = 'image-card__meta';

            const header = document.createElement('div');
            header.className = 'image-card__header';
            const title = document.createElement('h3');
            title.textContent = item.title || item.name;
            header.appendChild(title);
            meta.appendChild(header);

            if (item.caption) {
                const caption = document.createElement('p');
                caption.className = 'caption';
                caption.textContent = item.caption;
                meta.appendChild(caption);
            }

            if (item.author) {
                const author = document.createElement('p');
                author.className = 'author';
                author.textContent = `By ${item.author}`;
                meta.appendChild(author);
            }

            if (item.description) {
                const description = document.createElement('p');
                description.className = 'description';
                description.textContent = item.description;
                meta.appendChild(description);
            }

            if (item.tags && item.tags.length) {
                meta.appendChild(buildTagList(item.tags));
            }

            const footer = document.createElement('div');
            footer.className = 'image-card__footer';
            const filename = document.createElement('span');
            filename.className = 'filename';
            filename.textContent = item.name;
            footer.appendChild(filename);
            footer.appendChild(createCardActions(item, 'reviewed'));
            meta.appendChild(footer);

            card.appendChild(meta);
            galleryList.appendChild(card);
        });
    }

    function sortGalleryData(sortValue) {
        const [field, direction] = sortValue.split(':');
        const multiplier = direction === 'desc' ? -1 : 1;
        const sorted = [...reviewedData].sort((a, b) => {
            const valA = (a[field] || '').toString().toLowerCase();
            const valB = (b[field] || '').toString().toLowerCase();
            if (field === 'detected_at') {
                return ((a.detected_at || 0) - (b.detected_at || 0)) * multiplier;
            }
            if (valA < valB) return -1 * multiplier;
            if (valA > valB) return 1 * multiplier;
            return 0;
        });
        return sorted;
    }

    function sortPendingData(sortValue) {
        const [field, direction] = sortValue.split(':');
        const multiplier = direction === 'desc' ? -1 : 1;
        const sorted = [...pendingData].sort((a, b) => {
            if (field === 'detected_at') {
                return ((a.detected_at || 0) - (b.detected_at || 0)) * multiplier;
            }
            const av = (a[field] || a.title || a.name || '').toString().toLowerCase();
            const bv = (b[field] || b.title || b.name || '').toString().toLowerCase();
            if (av < bv) return -1 * multiplier;
            if (av > bv) return 1 * multiplier;
            return 0;
        });
        return sorted;
    }

    function filterGalleryData(list, query) {
        if (!query) {
            return list;
        }
        const term = query.toLowerCase();
        return list.filter((item) => {
            const tags = (item.tags || []).join(' ').toLowerCase();
            return (
                (item.title || '').toLowerCase().includes(term) ||
                (item.author || '').toLowerCase().includes(term) ||
                tags.includes(term)
            );
        });
    }

    function updateGalleryView() {
        const sorted = sortGalleryData(gallerySort.value);
        const filtered = filterGalleryData(sorted, galleryFilter.value.trim());
        applyGalleryView(filtered);
    }

    function updatePendingView() {
        const sorted = sortPendingData(pendingSort.value);
        renderPendingList(sorted);
    }

    function refreshCounts() {
        pendingCount.textContent = pendingData.length;
        galleryCount.textContent = reviewedData.length;
    }

    function renderDashboard(data) {
        pendingData = data.pending || [];
        reviewedData = data.reviewed || [];
        updatePendingView();
        updateGalleryView();
        refreshCounts();
    }

    function collectSelected() {
        return Array.from(pendingList.querySelectorAll('.item-select:checked')).map((checkbox) => {
            const card = checkbox.closest('.image-card');
            return card ? card.dataset.imageName : null;
        }).filter(Boolean);
    }

    async function fetchDashboard() {
        const response = await fetch('/admin/api/gallery');
        if (!response.ok) {
            throw new Error('Failed to load dashboard data');
        }
        return response.json();
    }

    async function triggerRegeneration(images, force = false) {
        if (!images.length) {
            showFeedback('Select at least one image to regenerate.', 'error');
            return;
        }
        try {
            const response = await fetch('/admin/ai/regenerate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images, force }),
            });
            if (!response.ok) {
                throw new Error('Failed to regenerate metadata');
            }
            const data = await response.json();
            if (data.errors && data.errors.length) {
                const details = data.errors.map((err) => `${err.name}: ${err.error}`).join(', ');
                showFeedback(`Some items failed to regenerate: ${details}`, 'error');
            } else {
                showFeedback('AI metadata refreshed successfully.');
            }
            renderDashboard(data);
        } catch (error) {
            console.error(error);
            showFeedback('Unable to contact the AI regeneration endpoint.', 'error');
        }
    }

    async function deleteImage(name) {
        try {
            const response = await fetch(`/admin/image/${encodeURIComponent(name)}`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                throw new Error('Failed to delete image');
            }
            const data = await response.json();
            showFeedback(data.message || 'Image removed.');
            renderDashboard(data);
        } catch (error) {
            console.error(error);
            showFeedback('Unable to delete the selected image.', 'error');
        }
    }

    // Initialize from saved config
    async function loadAdminConfig() {
        try {
            const response = await fetch('/admin/config');
            if (!response.ok) {
                throw new Error('Failed to fetch config');
            }
            const data = await response.json();
            const ai = data.ai || {};
            aiEnabled.checked = !!ai.enabled;
            aiStartupEnabled.checked = !!ai.startup_enrichment_enabled;
            sidecarStartupEnabled.checked = !!ai.startup_sidecar_enabled;
            sidecarMaxWorkers.value = ai.max_workers_create_sidecars ?? 2;
            if (ai.model && Array.from(aiModel.options).some((opt) => opt.value === ai.model)) {
                aiModel.value = ai.model;
            } else {
                aiModel.value = aiModel.options[0].value;
            }
            aiTemp.value = ai.temperature ?? 0.6;
            aiTokens.value = ai.max_output_tokens ?? 600;
        } catch (error) {
            console.error(error);
        }
    }

    renderDashboard(dashboardData);
    loadAdminConfig();

    dropzone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropzone.classList.add('is-dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('is-dragover');
    });

    dropzone.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropzone.classList.remove('is-dragover');
        const files = event.dataTransfer.files;
        if (!files.length) return;
        await uploadFiles(files);
    });

    selectFilesButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (event) => {
        if (!event.target.files.length) return;
        await uploadFiles(event.target.files);
        event.target.value = '';
    });

    async function uploadFiles(files) {
        const formData = new FormData();
        Array.from(files).forEach((file) => formData.append('files', file));
        try {
            const response = await fetch('/admin/upload', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                throw new Error('Failed to upload files');
            }
            const data = await response.json();
            showFeedback(data.message || 'Upload complete.');
            renderDashboard(data);
        } catch (error) {
            console.error(error);
            showFeedback('Upload failed. Please try again.', 'error');
        }
    }

    pathForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(pathForm);
        try {
            const response = await fetch('/admin/import-path', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                throw new Error('Failed to import path');
            }
            const data = await response.json();
            showFeedback(`Imported ${data.copied.length} items.`);
            renderDashboard(data);
            pathForm.reset();
        } catch (error) {
            console.error(error);
            showFeedback('Import failed. Verify the path and try again.', 'error');
        }
    });

    aiForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const payload = {
            ai: {
                enabled: aiEnabled.checked,
                startup_enrichment_enabled: aiStartupEnabled.checked,
                startup_sidecar_enabled: sidecarStartupEnabled.checked,
                max_workers_create_sidecars: parseInt(sidecarMaxWorkers.value || '2', 10),
                model: aiModel.value,
                temperature: parseFloat(aiTemp.value || '0.6'),
                max_output_tokens: parseInt(aiTokens.value || '600', 10),
            },
        };
        try {
            const response = await fetch('/admin/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                throw new Error('Failed to save config');
            }
            await response.json();
            showFeedback('AI settings saved.');
        } catch (error) {
            console.error(error);
            showFeedback('Unable to save AI configuration.', 'error');
        }
    });

    resetAiButton.addEventListener('click', async () => {
        try {
            const response = await fetch('/admin/config/reset', { method: 'POST' });
            if (!response.ok) {
                throw new Error('Failed to reset configuration');
            }
            const data = await response.json();
            const ai = data.ai || {};
            aiEnabled.checked = !!ai.enabled;
            aiStartupEnabled.checked = !!ai.startup_enrichment_enabled;
            sidecarStartupEnabled.checked = !!ai.startup_sidecar_enabled;
            sidecarMaxWorkers.value = ai.max_workers_create_sidecars ?? 2;
            aiModel.value = ai.model && Array.from(aiModel.options).some((opt) => opt.value === ai.model)
                ? ai.model
                : aiModel.options[0].value;
            aiTemp.value = ai.temperature ?? 0.6;
            aiTokens.value = ai.max_output_tokens ?? 600;
            showFeedback('AI settings reset to defaults.');
        } catch (error) {
            console.error(error);
            showFeedback('Unable to reset AI configuration.', 'error');
        }
    });

    selectAllBtn.addEventListener('click', () => {
        const checkboxes = pendingList.querySelectorAll('.item-select');
        const shouldSelectAll = Array.from(checkboxes).some((box) => !box.checked);
        checkboxes.forEach((box) => {
            box.checked = shouldSelectAll;
        });
    });

    regenBtn.addEventListener('click', () => {
        const selected = collectSelected();
        triggerRegeneration(selected, forceOverwrite.checked);
    });

    refreshButton.addEventListener('click', async () => {
        try {
            const data = await fetchDashboard();
            renderDashboard(data);
            showFeedback('Gallery refreshed.');
        } catch (error) {
            console.error(error);
            showFeedback('Unable to refresh gallery.', 'error');
        }
    });

    gallerySort.addEventListener('change', updateGalleryView);
    pendingSort.addEventListener('change', updatePendingView);
    galleryFilter.addEventListener('input', updateGalleryView);

    galleryList.addEventListener('click', (event) => {
        const action = event.target.dataset.action;
        if (!action) return;
        const card = event.target.closest('.image-card');
        if (!card) return;
        const name = card.dataset.imageName;
        if (!name) return;

        if (action === 'regen-single') {
            triggerRegeneration([name], forceOverwrite.checked);
        }
        if (action === 'delete-image') {
            if (window.confirm(`Delete ${name}? This cannot be undone.`)) {
                deleteImage(name);
            }
        }
    });
    </script>
</body>
</html>
