<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <title>Review {{ metadata.title }} &mdash; Artwork Admin</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">



  <link rel="stylesheet" href="{{ url_for('static', path='css/variables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
  
</head>
<body class="bg-light text-dark">

  <!-- Busy Overlay (aria-hidden based, consistent with admin pages) -->
  <div id="busy" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 z-3 d-flex align-items-center justify-content-center" aria-hidden="true">
    <div class="bg-white text-dark px-4 py-3 rounded shadow busy-indicator">Working…</div>
  </div>

  <!-- Header -->
  <header class="container-fluid py-4 border-bottom">
    <div class="d-flex justify-content-between flex-wrap align-items-center">
      <h1 class="h4 mb-3 mb-md-0">Review Metadata</h1>
      <nav class="d-flex gap-2 flex-wrap">
        <a href="{{ review_url }}" class="btn btn-outline-secondary">Back to pending list</a>
        <a href="/" class="btn btn-outline-secondary">View Public Gallery</a>
        <a href="/admin/advanced" class="btn btn-outline-secondary">Advanced Settings</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container my-4">

    <!-- Image Preview Panel -->
    <section class="card p-4 shadow-sm mb-4">
      <h2 class="h5 mb-4">{{ metadata.title }}</h2>

      <div class="row g-4 align-items-start">
        <!-- Image -->
        <div class="col-md-5">
          <img src="{{ image_url }}" alt="Preview of {{ metadata.title }}" class="img-fluid rounded border">
        </div>

        <!-- Metadata -->
        <div class="col-md-7">
          <dl class="row">
            <dt class="col-sm-4">Filename</dt>
            <dd class="col-sm-8">{{ image_name }}</dd>

            <dt class="col-sm-4">Image URL</dt>
            <dd class="col-sm-8">
              <a href="{{ image_url }}" target="_blank" rel="noopener">{{ image_url }}</a>
            </dd>

            <dt class="col-sm-4">AI Status</dt>
            <dd class="col-sm-8 d-flex flex-wrap gap-2 align-items-center">
              {% if metadata.get('ai_generated') %}
                <span class="badge bg-secondary">AI generated</span>
              {% else %}
                <span class="badge bg-light text-dark border">AI pending</span>
              {% endif %}
              {% set ai = metadata.get('ai_details') or {} %}
              {% set ai_time = ai.get('created') or ai.get('attempted_at') or metadata.get('detected_at') %}
              {% if ai_time %}
                <span class="text-muted small timestamp" data-ts="{{ ai_time }}"></span>
              {% endif %}
            </dd>

            <dt class="col-sm-4">Caption</dt>
            <dd class="col-sm-8" data-field="caption">{{ metadata.caption or '—' }}</dd>

            <dt class="col-sm-4">Author</dt>
            <dd class="col-sm-8" data-field="author">{{ metadata.author or '—' }}</dd>

            <dt class="col-sm-4">Tags</dt>
            <dd class="col-sm-8" data-field="tags">
              {% if metadata.tags %}
                {{ metadata.tags | join(', ') }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Copyright</dt>
            <dd class="col-sm-8" data-field="copyright">{{ metadata.copyright or '—' }}</dd>
          </dl>
        </div>
      </div>
    </section>

    <!-- Metadata Form Panel -->
    <section class="card p-4 shadow-sm">
      <h2 class="h5 mb-3">
        Edit text for this image
        <span class="ms-2 text-muted small" title="Edit fields below to customize what visitors see. Saving updates the JSON sidecar.">ℹ️</span>
      </h2>

      <p class="text-muted small mb-4">Update the fields below to control what appears in the public gallery. Saving will update or create the JSON sidecar.</p>

      <form class="vstack gap-4 metadata-form" method="post" action="{{ url_for('update_image_metadata', image_name=image_name) }}">
        <!-- Title -->
        <div>
          <label for="title" class="form-label">Title</label>
          <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" id="title" name="title" value="{{ metadata.title | e }}" required>
            <div class="form-check">
              <input class="form-check-input regen-field" type="checkbox" id="regen-title" data-field="title">
              <label class="form-check-label small" for="regen-title">Regen</label>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="form-label">Description</label>
          <div class="d-flex align-items-center gap-2">
            <textarea class="form-control" id="description" name="description" rows="5">{{ metadata.description | e }}</textarea>
            <div class="form-check">
              <input class="form-check-input regen-field" type="checkbox" id="regen-description" data-field="description">
              <label class="form-check-label small" for="regen-description">Regen</label>
            </div>
          </div>
        </div>

        <!-- Caption -->
        <div>
          <label for="caption" class="form-label">Caption</label>
          <div class="d-flex align-items-center gap-2">
            <textarea class="form-control" id="caption" name="caption" rows="2">{{ metadata.caption | e }}</textarea>
            <div class="form-check">
              <input class="form-check-input regen-field" type="checkbox" id="regen-caption" data-field="caption">
              <label class="form-check-label small" for="regen-caption">Regen</label>
            </div>
          </div>
        </div>

        <!-- Author -->
        <div>
          <label for="author" class="form-label">Author</label>
          <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" id="author" name="author" value="{{ metadata.author | e }}">
            <div class="form-check">
              <input class="form-check-input regen-field" type="checkbox" id="regen-author" data-field="author">
              <label class="form-check-label small" for="regen-author">Regen</label>
            </div>
          </div>
        </div>

        <!-- Copyright -->
        <div>
          <label for="copyright" class="form-label">Copyright</label>
          <input type="text" class="form-control" id="copyright" name="copyright"
                 value="{{ metadata.copyright | e }}"
                 placeholder="© 2024 Jane Doe">
        </div>

        <!-- Tags -->
        <div>
          <label for="tags" class="form-label">Tags</label>
          <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" id="tags" name="tags" value="{{ metadata.tags | join(', ') | e }}">
            <div class="form-check">
              <input class="form-check-input regen-field" type="checkbox" id="regen-tags" data-field="tags">
              <label class="form-check-label small" for="regen-tags">Regen</label>
            </div>
          </div>
          <small class="text-muted">Separate tags with commas.</small>
        </div>

        <!-- Force Overwrite -->
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="detail-force">
          <label class="form-check-label" for="detail-force">
            Force overwrite existing text when regenerating
          </label>
        </div>

        <!-- Regenerate Button -->
        <div>
          <button type="button" id="regen-image" class="btn btn-outline-primary w-100">
            Regenerate metadata
          </button>
        </div>

        <!-- Form Actions -->
        <div class="d-flex flex-wrap gap-2">
          <button type="submit" name="action" value="save" class="btn btn-dark">OK</button>
          <button type="submit" name="action" value="cancel" class="btn btn-outline-secondary">Cancel</button>
          <button type="submit" name="action" value="mark_unreviewed" class="btn btn-outline-warning">Mark as pending</button>
        </div>

        <!-- Feedback -->
        <p id="detail-feedback" class="text-danger small mt-3" hidden></p>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer class="text-center py-4 border-top text-muted small">
    Artwork Gallery Administration
  </footer>

  <!-- Optional script injection -->
  <script>
    // Your original JS for timestamps, busy overlay, form handling remains here
    function showBusy(){ const el=document.getElementById('busy'); if(el) el.setAttribute('aria-hidden','false'); }
    function hideBusy(){ const el=document.getElementById('busy'); if(el) el.setAttribute('aria-hidden','true'); }
    (function () {
        const timestampEls = document.querySelectorAll('.timestamp[data-ts]');
        timestampEls.forEach((el) => {
            const ts = parseFloat(el.getAttribute('data-ts'));
            if (!isNaN(ts)) {
                el.textContent = ' · ' + new Date(ts * 1000).toLocaleString();
            }
        });

        const regenButton = document.getElementById('regen-image');
        const forceToggle = document.getElementById('detail-force');
        const feedback = document.getElementById('detail-feedback');
        const imageName = {{ image_name | tojson }};

        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const captionInput = document.getElementById('caption');
        const authorInput = document.getElementById('author');
        const copyrightInput = document.getElementById('copyright');
        const tagsInput = document.getElementById('tags');

        const detailFields = {
            caption: document.querySelector('[data-field="caption"]'),
            author: document.querySelector('[data-field="author"]'),
            tags: document.querySelector('[data-field="tags"]'),
            copyright: document.querySelector('[data-field="copyright"]'),
        };

        function setFeedback(message, isError = false) {
            feedback.textContent = message;
            feedback.hidden = false;
            feedback.classList.remove('error', 'success');
            feedback.classList.toggle('error', isError);
            feedback.classList.toggle('success', !isError);
        }

        function updateDetailField(key, value) {
            const target = detailFields[key];
            if (!target) return;
            if (Array.isArray(value)) {
                target.textContent = value.length ? value.join(', ') : '—';
            } else {
                target.textContent = value ? value : '—';
            }
        }

        async function regenerateMetadata() {
            setFeedback('Regenerating metadata…');
            const prevDisabled = regenButton.disabled;
            regenButton.disabled = true;
            showBusy();
            try {
                const selectedFields = Array.from(document.querySelectorAll('.regen-field:checked'))
                    .map((el) => el.getAttribute('data-field'))
                    .filter(Boolean);
                const response = await fetch('/admin/ai/regenerate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: [imageName], force: !!forceToggle?.checked, fields: selectedFields }),
                });
                if (!response.ok) {
                    throw new Error('Request failed');
                }
                const data = await response.json();
                const match = (data.updated || []).find((item) => item.name === imageName);
                if (!match || !match.metadata) {
                    setFeedback('Regeneration finished but no metadata was returned.', true);
                    return;
                }
                const meta = match.metadata;
                if (meta.title) {
                    titleInput.value = meta.title;
                }
                if (meta.description) {
                    descriptionInput.value = meta.description;
                }
                if (meta.caption !== undefined) {
                    captionInput.value = meta.caption || '';
                    updateDetailField('caption', meta.caption || '');
                }
                if (meta.author !== undefined) {
                    authorInput.value = meta.author || '';
                    updateDetailField('author', meta.author || '');
                }
                if (meta.copyright !== undefined) {
                    copyrightInput.value = meta.copyright || '';
                    updateDetailField('copyright', meta.copyright || '');
                }
                if (meta.tags !== undefined) {
                    const tags = Array.isArray(meta.tags) ? meta.tags : [];
                    tagsInput.value = tags.join(', ');
                    updateDetailField('tags', tags);
                }
                setFeedback('Metadata regenerated. Review and save to keep these changes.');
            } catch (error) {
                console.error(error);
                setFeedback('Unable to regenerate metadata at this time.', true);
            } finally {
                regenButton.disabled = prevDisabled;
                hideBusy();
            }
        }

        if (regenButton) {
            regenButton.addEventListener('click', regenerateMetadata);
        }

        // Show busy while submitting the form
        const form = document.querySelector('.metadata-form');
        if (form){
            form.addEventListener('submit', ()=>{ showBusy(); });
        }
    })();
  </script>
</body>
</html>
