{% extends "admin_base.html" %}

{% block title %}Advanced Settings — Artwork Admin{% endblock %}
{% block page_heading %}Advanced Settings{% endblock %}

{% block content %}
  <section class="card p-4 shadow-sm mb-4">
    <h2 class="h5 mb-3">Logging</h2>
    <div class="row g-3 align-items-center">
      <div class="col-sm-6 col-md-4">
        <label for="log_level" class="form-label">Console log level</label>
        <select id="log_level" class="form-select">
          {% for lvl in ["DEBUG","INFO","WARNING","ERROR","CRITICAL"] %}
          <option value="{{ lvl }}" {% if advanced.log_level==lvl %}selected{% endif %}>{{ lvl }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-6 col-md-4">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="file_log" {% if advanced.file_log %}checked{% endif %}>
          <label class="form-check-label" for="file_log">Enable file logging (logs/app.log)</label>
        </div>
      </div>
      <div class="col-sm-6 col-md-4">
        <label for="file_log_level" class="form-label">File log level</label>
        <select id="file_log_level" class="form-select">
          {% for lvl in ["DEBUG","INFO","WARNING","ERROR","CRITICAL"] %}
          <option value="{{ lvl }}" {% if advanced.file_log_level==lvl %}selected{% endif %}>{{ lvl }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </section>

  <section class="card p-4 shadow-sm mb-4">
    <h2 class="h5 mb-3">Metadata Defaults</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <label for="default_author" class="form-label">Default author for imports</label>
        <input id="default_author" class="form-control" type="text" placeholder="e.g., Jane Doe" value="{{ advanced.default_author }}">
      </div>
      <div class="col-md-6">
        <label for="default_copyright" class="form-label">Default copyright for imports</label>
        <input id="default_copyright" class="form-control" type="text" placeholder="© 2024 Jane Doe" value="{{ advanced.default_copyright }}">
      </div>
    </div>
  </section>

  <section class="card p-4 shadow-sm mb-4">
    <h2 class="h5 mb-3">AI Debug + Timeouts</h2>
    <div class="row g-3 align-items-center">
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="ai_metadata_debug_dump" {% if advanced.ai_metadata_debug_dump %}checked{% endif %}>
          <label class="form-check-label" for="ai_metadata_debug_dump">Save AI debug dumps to logs/ai</label>
        </div>
      </div>
      <div class="col-md-6">
        <label for="openai_timeout_seconds" class="form-label">OpenAI timeout (seconds)</label>
        <input id="openai_timeout_seconds" class="form-control" type="number" min="5" step="1" value="{{ advanced.openai_timeout_seconds }}">
      </div>
    </div>
  </section>

  <div class="d-flex gap-2 flex-wrap mb-3">
    <button id="save-advanced" class="btn btn-dark">Save settings</button>
    <button id="reset-advanced" class="btn btn-outline-secondary">Reset to defaults</button>
  </div>
  <p id="feedback" class="small text-success" role="status" aria-live="polite" hidden></p>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    function showBusy(){ const el=document.getElementById('busy'); if(el) el.setAttribute('aria-hidden','false'); }
    function hideBusy(){ const el=document.getElementById('busy'); if(el) el.setAttribute('aria-hidden','true'); }
    const feedback = document.getElementById('feedback');
    function showFeedback(msg, type){
      feedback.hidden = false; feedback.textContent = msg;
      feedback.classList.remove('text-danger','text-success');
      feedback.classList.add(type==='error' ? 'text-danger' : 'text-success');
    }
    async function saveAdvanced(){
      showBusy();
      try{
        const payload = {
          log_level: document.getElementById('log_level').value,
          file_log: document.getElementById('file_log').checked,
          file_log_level: document.getElementById('file_log_level').value,
          ai_metadata_debug_dump: document.getElementById('ai_metadata_debug_dump').checked,
          openai_timeout_seconds: parseFloat(document.getElementById('openai_timeout_seconds').value || '30'),
          default_author: document.getElementById('default_author').value || '',
          default_copyright: document.getElementById('default_copyright').value || '',
        };
        const res = await fetch('/admin/advanced', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!res.ok) throw new Error('Failed');
        await res.json();
        showFeedback('Advanced settings saved.');
      }catch(err){ console.error(err); showFeedback('Unable to save settings.', 'error'); }
      finally{ hideBusy(); }
    }
    async function resetAdvanced(){
      showBusy();
      try{
        const res = await fetch('/admin/advanced/reset', {method:'POST'});
        if(!res.ok) throw new Error('Failed');
        const data = await res.json();
        const adv = data.advanced || {};
        document.getElementById('log_level').value = adv.log_level || 'INFO';
        document.getElementById('file_log').checked = !!adv.file_log;
        document.getElementById('file_log_level').value = adv.file_log_level || adv.log_level || 'INFO';
        document.getElementById('ai_metadata_debug_dump').checked = !!adv.ai_metadata_debug_dump;
        document.getElementById('openai_timeout_seconds').value = adv.openai_timeout_seconds || 30;
        document.getElementById('default_author').value = adv.default_author || '';
        document.getElementById('default_copyright').value = adv.default_copyright || '';
        showFeedback('Advanced settings reset to defaults.');
      }catch(err){ console.error(err); showFeedback('Unable to reset settings.', 'error'); }
      finally{ hideBusy(); }
    }
    document.getElementById('save-advanced').addEventListener('click', saveAdvanced);
    document.getElementById('reset-advanced').addEventListener('click', resetAdvanced);
  </script>
{% endblock %}
